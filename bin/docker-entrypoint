#!/bin/bash
set -e

echo "====================================="
echo "ğŸš€ Starting Rails Application on Railway"
echo "====================================="

# Check Google Client Secret ENV
if [ -n "$GOOGLE_CLIENT_SECRET_JSON" ]; then
  echo "ğŸ“¦ GOOGLE_CLIENT_SECRET_JSON is set: YES"
  echo "$GOOGLE_CLIENT_SECRET_JSON" > /tmp/client_secret.json
  export GOOGLE_CLIENT_SECRET_PATH="/tmp/client_secret.json"
  echo "âœ… client_secret.json written to /tmp"
else
  echo "âš ï¸ GOOGLE_CLIENT_SECRET_JSON not found â€” Gmail API may fail."
fi

# Run database migrations safely
echo "ğŸ§© Running database migrations..."
bundle exec rails db:migrate || true
echo "âœ… Database migration complete."

# Pick up dynamic Railway port
PORT=${PORT:-3000}
echo "ğŸŒ Using port: $PORT"

# Start the Rails server
echo "ğŸ¦„ Booting Puma..."
exec bundle exec rails server -b 0.0.0.0 -p $PORT
